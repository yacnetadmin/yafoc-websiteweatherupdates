name: Update Weather Alert

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'Alert message'
        required: false
        type: string
        default: ''
      york:
        description: 'York campus affected'
        required: false
        type: boolean
        default: false
      springGrove:
        description: 'Spring Grove campus affected'
        required: false
        type: boolean
        default: false
      stewartstown:
        description: 'Stewartstown campus affected'
        required: false
        type: boolean
        default: false
      validForHours:
        description: 'Valid duration in hours'
        required: false
        type: number
        default: 0
      issuedAt:
        description: 'Issued timestamp'
        required: false
        type: string
        default: ''
      validUntil:
        description: 'Expiration timestamp'
        required: false
        type: string
        default: ''

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update weather data
        run: |
          # Handle null/empty values properly
          MESSAGE="${{ inputs.message }}"
          VALID_HOURS="${{ inputs.validForHours }}"
          VALID_UNTIL="${{ inputs.validUntil }}"
          ISSUED_AT="${{ inputs.issuedAt }}"
          
          # Convert to proper null values if empty
          if [ -z "$MESSAGE" ]; then MESSAGE_JSON="null"; else MESSAGE_JSON="\"$MESSAGE\""; fi
          if [ "$VALID_HOURS" = "0" ] || [ -z "$VALID_HOURS" ]; then HOURS_JSON="null"; else HOURS_JSON="$VALID_HOURS"; fi
          if [ -z "$VALID_UNTIL" ]; then UNTIL_JSON="null"; else UNTIL_JSON="\"$VALID_UNTIL\""; fi
          if [ -z "$ISSUED_AT" ]; then ISSUED_JSON="null"; else ISSUED_JSON="\"$ISSUED_AT\""; fi
          
          cat > weather-update.json << EOF
          {
            "campuses": {
              "york": ${{ inputs.york }},
              "springGrove": ${{ inputs.springGrove }},
              "stewartstown": ${{ inputs.stewartstown }}
            },
            "message": $MESSAGE_JSON,
            "validForHours": $HOURS_JSON,
            "validUntil": $UNTIL_JSON,
            "issuedAt": $ISSUED_JSON
          }
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "Weather Update Bot"
          git config user.email "weather-update-bot@users.noreply.github.com"
          git add weather-update.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update weather alert: ${{ inputs.message }}"
            git push
          fi
